{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "ws.feedback",
  "type": "object",
  "additionalProperties": false,
  "required": ["run_id", "task_id"],
  "properties": {
    "run_id": {
      "type": "string",
      "minLength": 1
    },
    "task_id": {
      "type": "string",
      "minLength": 1
    },
    "stage": {
      "type": "string",
      "minLength": 1,
      "description": "Optional scheduler-facing stage hint (e.g. running, streaming, completed_partial)."
    },
    "progress": {
      "type": "number",
      "minimum": 0,
      "maximum": 1,
      "description": "Optional 0-1 normalized progress indicator."
    },
    "message": {
      "type": "string",
      "description": "Human friendly status line exposed to UI surfaces."
    },
    "chunks": {
      "type": "array",
      "description": "Streaming feedback emitted by the adapter (stdout/log/LLM tokens/etc).",
      "items": {
        "$ref": "#/definitions/FeedbackChunk"
      }
    },
    "metrics": {
      "type": "object",
      "description": "Optional numeric metrics emitted during execution (loss, throughput, etc).",
      "additionalProperties": {
        "type": "number"
      }
    },
    "metadata": {
      "type": "object",
      "description": "Implementation-defined details; forwarded to observability sinks.",
      "additionalProperties": true
    }
  },
  "definitions": {
    "FeedbackChunk": {
      "type": "object",
      "additionalProperties": false,
      "required": ["channel"],
      "properties": {
        "channel": {
          "type": "string",
          "enum": [
            "stdout",
            "stderr",
            "log",
            "llm",
            "metric",
            "custom"
          ]
        },
        "index": {
          "type": "integer",
          "minimum": 0,
          "description": "Optional adapter-supplied sequence number for ordering within the channel."
        },
        "mime_type": {
          "type": "string",
          "description": "MIME type of the payload (defaults to text/plain; use application/json for structured logs)."
        },
        "text": {
          "type": "string",
          "description": "UTF-8 text payload for the chunk. Mutually exclusive with data_base64."
        },
        "data_base64": {
          "type": "string",
          "description": "Binary payload encoded as base64 (for non-textual feedback)."
        },
        "metadata": {
          "type": "object",
          "description": "Free-form annotations. Suggested keys: token_count, role, level.",
          "additionalProperties": true
        }
      }
    }
  }
}
